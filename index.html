<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MERRY CHRISTMAS QUỲNH</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#02162b; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #stage { position:fixed; inset:0; }
    #txt {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      color:#fff; text-align:center; letter-spacing:2px; font-weight:800;
      text-shadow: 0 6px 30px rgba(0,0,0,.55);
      user-select:none; pointer-events:none;
      padding: 6vw;
      line-height: 1.05;
      font-size: clamp(34px, 7vw, 110px);
      white-space: pre-line;
    }
    #photoWrap{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(2,22,43,.92);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      z-index: 10;
    }
    #photo{
      max-width: 96vw;
      max-height: 96vh;
      object-fit: contain;
      border-radius: 18px;
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      background: rgba(255,255,255,.06);
    }
    #hud {
      position:fixed; left:14px; bottom:14px; right:14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      z-index: 20;
      color: rgba(255,255,255,.75);
      font-size: 13px;
    }
    #hudLeft{ display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    button{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    #debug { opacity:.75; }
    #video { display:none; }
    #camWarn{
      position:fixed; top:14px; left:50%; transform:translateX(-50%);
      padding:10px 12px; border-radius:12px;
      background: rgba(0,0,0,.35); color:#fff; z-index: 30;
      display:none;
      max-width: min(920px, 92vw);
      text-align:center;
    }
  </style>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
</head>
<body>
  <div id="stage"></div>

  <!-- Default text view -->
  <div id="txt">MERRY CHRISTMAS
QUỲNH</div>

  <!-- Fullscreen photo view -->
  <div id="photoWrap">
    <img id="photo" alt="memory" />
  </div>

  <div id="camWarn"></div>

  <div id="hud">
    <div id="hudLeft">
      <button id="btnUpload">Upload Memories</button>
      <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
      <button id="btnPrev" title="Ảnh trước">Prev</button>
      <button id="btnNext" title="Ảnh tiếp theo">Next</button>
      <span id="debug"></span>
    </div>
    <div>
      ✋ Xòe tay: xem ảnh (mỗi lần xòe chuyển ảnh) · ✊ Nắm tay: quay lại chữ
    </div>
  </div>

  <video id="video" playsinline></video>

<script>
(() => {
  // ---------- Simple state ----------
  const txt = document.getElementById('txt');
  const photoWrap = document.getElementById('photoWrap');
  const photoEl = document.getElementById('photo');
  const debugEl = document.getElementById('debug');
  const camWarn = document.getElementById('camWarn');

  const btnUpload = document.getElementById('btnUpload');
  const fileInput = document.getElementById('fileInput');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');

  // List of images (auto from /images/1..N with common extensions)
  const gallery = [];
  let idx = 0;

  // Try preload common files; if missing, we just won't add.
  // Note: GitHub Pages is case-sensitive.
  const candidateExts = ['jpg','jpeg','png','webp'];
  const MAX_AUTO = 30;

  function addIfLoads(url) {
    return new Promise(resolve => {
      const im = new Image();
      im.onload = () => resolve(url);
      im.onerror = () => resolve(null);
      im.src = url;
    });
  }

  async function autoDiscover() {
    const found = [];
    for (let i = 1; i <= MAX_AUTO; i++) {
      for (const ext of candidateExts) {
        const url = `./images/${i}.${ext}`;
        // eslint-disable-next-line no-await-in-loop
        const ok = await addIfLoads(url);
        if (ok) { found.push(ok); break; }
      }
    }
    if (found.length) {
      gallery.splice(0, gallery.length, ...found);
    } else {
      // Fallback: a generated placeholder so UI still works
      const canvas = document.createElement('canvas');
      canvas.width = 1400; canvas.height = 900;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#0b3a6f'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = 'rgba(255,255,255,.12)';
      for (let i=0;i<80;i++){
        ctx.beginPath();
        const x=Math.random()*canvas.width, y=Math.random()*canvas.height, r=2+Math.random()*8;
        ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      }
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 92px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.textAlign = 'center'; ctx.textBaseline='middle';
      ctx.fillText('MERRY CHRISTMAS', canvas.width/2, canvas.height/2 - 60);
      ctx.fillText('QUỲNH', canvas.width/2, canvas.height/2 + 60);
      gallery.splice(0, gallery.length, canvas.toDataURL('image/png'));
    }
    updateDebug();
  }

  function updateDebug(extra='') {
    debugEl.textContent = `Photos: ${gallery.length} · Index: ${idx+1}/${gallery.length}` + (extra ? ` · ${extra}` : '');
  }

  function showText() {
    photoWrap.style.display = 'none';
    txt.style.display = 'flex';
  }

  function showPhoto(i) {
    if (!gallery.length) return;
    idx = (i + gallery.length) % gallery.length;
    photoEl.src = gallery[idx];
    txt.style.display = 'none';
    photoWrap.style.display = 'flex';
    updateDebug();
  }

  function nextPhoto() { showPhoto(idx + 1); }
  function prevPhoto() { showPhoto(idx - 1); }

  btnNext.onclick = () => nextPhoto();
  btnPrev.onclick = () => prevPhoto();

  btnUpload.onclick = () => fileInput.click();
  fileInput.addEventListener('change', () => {
    const files = Array.from(fileInput.files || []);
    if (!files.length) return;
    const urls = files.map(f => URL.createObjectURL(f));
    gallery.splice(0, gallery.length, ...urls);
    idx = 0;
    showPhoto(0);
    updateDebug('Uploaded');
  });

  // ---------- Gesture detection (MediaPipe Hands) ----------
  // We detect:
  // - OPEN PALM: 4 fingers extended + thumb extended (heuristic)
  // - FIST: 4 fingertips below their PIP joints (folded)
  //
  // Tips: 4, 8, 12, 16, 20
  // PIPs: 3, 6, 10, 14, 18 (thumb uses IP=3 as "pip")
  const tipIds = { thumb:4, index:8, middle:12, ring:16, pinky:20 };
  const pipIds = { thumb:3, index:6, middle:10, ring:14, pinky:18 };

  function isFingerExtended(lm, tip, pip) {
    // In image coordinates: y smaller means higher (finger up).
    return lm[tip].y < lm[pip].y - 0.02;
  }

  function isFingerFolded(lm, tip, pip) {
    return lm[tip].y > lm[pip].y + 0.02;
  }

  function classifyHand(lm) {
    const ext = {
      thumb: isFingerExtended(lm, tipIds.thumb, pipIds.thumb),
      index: isFingerExtended(lm, tipIds.index, pipIds.index),
      middle: isFingerExtended(lm, tipIds.middle, pipIds.middle),
      ring: isFingerExtended(lm, tipIds.ring, pipIds.ring),
      pinky: isFingerExtended(lm, tipIds.pinky, pipIds.pinky),
    };
    const folded = {
      index: isFingerFolded(lm, tipIds.index, pipIds.index),
      middle: isFingerFolded(lm, tipIds.middle, pipIds.middle),
      ring: isFingerFolded(lm, tipIds.ring, pipIds.ring),
      pinky: isFingerFolded(lm, tipIds.pinky, pipIds.pinky),
    };

    const extCount = Object.values(ext).filter(Boolean).length;
    const foldedCount = Object.values(folded).filter(Boolean).length;

    // OPEN PALM: most fingers extended
    if (extCount >= 4) return 'PALM';

    // FIST: most fingers folded (ignore thumb for robustness)
    if (foldedCount >= 3) return 'FIST';

    return 'OTHER';
  }

  // Debounce so it doesn't spam
  let lastGesture = 'NONE';
  let lastActionAt = 0;
  const COOLDOWN_MS = 900;

  function canAct() {
    const now = performance.now();
    if (now - lastActionAt < COOLDOWN_MS) return false;
    lastActionAt = now;
    return true;
  }

  // Setup MediaPipe
  const videoEl = document.getElementById('video');
  const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });
  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6
  });

  hands.onResults((results) => {
    let label = 'NONE';
    if (results.multiHandLandmarks && results.multiHandLandmarks.length) {
      label = classifyHand(results.multiHandLandmarks[0]);
    }
    // Update HUD
    updateDebug(label);

    if (label === 'PALM' && lastGesture !== 'PALM') {
      lastGesture = 'PALM';
      if (canAct()) {
        // On PALM: show photo fullscreen, and advance each time
        if (photoWrap.style.display !== 'flex') showPhoto(idx);
        else nextPhoto();
      }
    } else if (label === 'FIST' && lastGesture !== 'FIST') {
      lastGesture = 'FIST';
      if (canAct()) {
        // On FIST: hide photo, show text
        showText();
      }
    } else if (label === 'OTHER') {
      lastGesture = 'OTHER';
    }
  });

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      videoEl.srcObject = stream;
      await videoEl.play();

      const camera = new Camera(videoEl, {
        onFrame: async () => {
          await hands.send({ image: videoEl });
        },
        width: 640,
        height: 480
      });
      camera.start();
      camWarn.style.display = 'none';
    } catch (e) {
      camWarn.style.display = 'block';
      camWarn.textContent = 'Không mở được camera. Hãy cho phép quyền camera trong trình duyệt (Chrome) và dùng HTTPS (GitHub Pages OK). Bạn vẫn có thể bấm Prev/Next/Upload để xem ảnh.';
      console.error(e);
    }
  }

  // Init
  showText();
  autoDiscover().then(() => {
    // Keep at text until palm gesture or user clicks next
  });
  startCamera();
})();
</script>
</body>
</html>
